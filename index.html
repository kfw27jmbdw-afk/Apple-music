<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Music Pro </title>
    <style>
        :root { --apple-blue: #007aff; --bg: #f5f5f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .player-card { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; }
        .btn-drive { background: var(--apple-blue); color: white; border: none; padding: 15px 25px; border-radius: 15px; font-size: 16px; font-weight: 600; width: 100%; cursor: pointer; margin-bottom: 20px; }
        .song-row { display: flex; align-items: center; padding: 12px; background: #fafafa; border-radius: 15px; margin-bottom: 10px; border: 1px solid #efeff4; text-align: left; }
        .song-art { width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; background: #eee; }
        .song-details { flex-grow: 1; overflow: hidden; }
        .song-details h4 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-details p { margin: 2px 0 0; font-size: 12px; color: #888; }
        .play-btn { background: var(--apple-blue); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; }
        audio { width: 100%; margin-top: 15px; }
        #status-msg { font-size: 11px; color: var(--apple-blue); margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body onload="render()">

<div class="player-card">
    <h2>My Cloud Library </h2>
    <p id="status-msg">Ready to stream</p>
    
    <button id="auth_btn" class="btn-drive" onclick="handleAuthClick()">Add Music from Drive</button>
    
    <div id="list-container"></div>

    <div id="mini-player" style="display:none; margin-top: 20px;">
        <img id="current-art" src="" style="width:100px; height:100px; border-radius:15px; margin-bottom:10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <p id="now-playing" style="font-size: 14px; font-weight: bold; margin: 5px 0;"></p>
        <p id="now-artist" style="font-size: 12px; color: #888; margin-bottom: 10px;"></p>
        <audio id="audio-engine" controls crossorigin="anonymous"></audio>
    </div>
</div>

<script>
    const CLIENT_ID = '493639014923-7gqsn4g853icgtctj6hhugkcqhm6178e.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAtjXuMkQe9UZzWb-cNsztYy0II9StI08U';
    
    let tokenClient;
    let accessToken = localStorage.getItem('gdrive_token');
    let cloudPlaylist = JSON.parse(localStorage.getItem('my_cloud_songs') || '[]');

    function gapiLoaded() {
        gapi.load('client:picker', async () => {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.readonly',
            ux_mode: 'popup',
            callback: (resp) => {
                if (resp.access_token) {
                    accessToken = resp.access_token;
                    localStorage.setItem('gdrive_token', accessToken);
                    openPicker();
                }
            },
        });
    }

    function handleAuthClick() {
        accessToken ? openPicker() : tokenClient.requestAccessToken({prompt: ''});
    }

    function openPicker() {
        const view = new google.picker.View(google.picker.ViewId.DOCS);
        view.setMimeTypes("audio/mpeg,audio/mp3,audio/wav");
        const picker = new google.picker.PickerBuilder()
            .addView(view)
            .setOAuthToken(accessToken)
            .setDeveloperKey(API_KEY)
            .setCallback(pickerCallback)
            .build();
        picker.setVisible(true);
    }

    // --- ASLI MAGIC YAHAN HAI: Drive File + iTunes Search ---
    async function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
            const file = data.docs[0];
            const driveName = file.name.replace(/\.[^/.]+$/, ""); // Extension hatao (.mp3)
            
            document.getElementById('status-msg').innerText = "Fetching Artwork for " + driveName + "...";

            try {
                // iTunes se asli metadata search karo
                const itunesRes = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(driveName)}&entity=song&limit=1`);
                const itunesData = await itunesRes.json();

                let songEntry = {
                    id: file.id,
                    title: driveName,
                    artist: "Unknown Artist",
                    art: "https://via.placeholder.com/100?text=No+Art"
                };

                if (itunesData.results.length > 0) {
                    const match = itunesData.results[0];
                    songEntry.title = match.trackName;
                    songEntry.artist = match.artistName;
                    // High quality art (1000x1000)
                    songEntry.art = match.artworkUrl100.replace('100x100bb.jpg', '1000x1000bb.jpg');
                }

                cloudPlaylist.push(songEntry);
                localStorage.setItem('my_cloud_songs', JSON.stringify(cloudPlaylist));
                document.getElementById('status-msg').innerText = "Song Added!";
                render();

            } catch (err) {
                console.log("iTunes Error, adding default.");
                cloudPlaylist.push({ id: file.id, title: driveName, artist: "Drive Audio", art: "" });
                render();
            }
        }
    }

    function render() {
        const container = document.getElementById('list-container');
        if (!container) return;
        container.innerHTML = cloudPlaylist.map((song, i) => `
            <div class="song-row">
                <img class="song-art" src="${song.art}">
                <div class="song-details">
                    <h4>${song.title}</h4>
                    <p>${song.artist}</p>
                </div>
                <button class="play-btn" onclick="playCloudSong('${song.id}', '${song.title}', '${song.artist}', '${song.art}')">Play</button>
            </div>
        `).join('');
    }

    async function playCloudSong(id, title, artist, art) {
        const audio = document.getElementById('audio-engine');
        const streamUrl = `https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`;
        
        document.getElementById('current-art').src = art;
        document.getElementById('now-playing').innerText = title;
        document.getElementById('now-artist').innerText = artist;
        document.getElementById('mini-player').style.display = 'block';

        audio.src = streamUrl;
        audio.load();
        audio.play();

        // Background Caching
        const musicCache = await caches.open('apple-music-cache-v1');
        const cached = await musicCache.match(streamUrl);
        if (!cached) {
            fetch(streamUrl).then(res => { if(res.ok) musicCache.put(streamUrl, res); });
        }
    }
</script>

<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

</body>
</html>
