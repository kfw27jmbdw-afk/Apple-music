<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Music Pro </title>
    <style>
        :root { --apple-blue: #007aff; --bg: #f5f5f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .player-card { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; }
        .btn-drive { background: var(--apple-blue); color: white; border: none; padding: 15px 25px; border-radius: 15px; font-size: 16px; font-weight: 600; width: 100%; cursor: pointer; margin-bottom: 20px; }
        .song-row { display: flex; align-items: center; padding: 12px; background: #fafafa; border-radius: 15px; margin-bottom: 10px; border: 1px solid #efeff4; text-align: left; cursor: pointer; }
        .song-art { width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; background: #ddd; }
        .song-details { flex-grow: 1; overflow: hidden; }
        .song-details h4 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #1d1d1f; }
        .song-details p { margin: 2px 0 0; font-size: 12px; color: #8e8e93; }
        audio { width: 100%; margin-top: 15px; }
        #status-msg { font-size: 11px; color: var(--apple-blue); margin-bottom: 10px; font-weight: bold; min-height: 1.2em; }
        .now-playing-box { margin-top: 20px; padding: 15px; border-top: 1px solid #eee; display: none; }
        #current-art { width: 120px; height: 120px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 10px; }
    </style>
</head>
<body onload="render()">

<div class="player-card">
    <h2>Cloud Library </h2>
    <p id="status-msg">Ready to Sync</p>
    
    <button id="auth_btn" class="btn-drive" onclick="handleAuthClick()">Add from Google Drive</button>
    
    <div id="list-container"></div>

    <div id="mini-player" class="now-playing-box">
        <img id="current-art" src="">
        <h4 id="now-playing-title" style="margin: 5px 0;"></h4>
        <p id="now-playing-artist" style="margin: 0 0 10px; color: #888; font-size: 13px;"></p>
        <audio id="audio-engine" controls crossorigin="anonymous"></audio>
    </div>
</div>

<script>
    const CLIENT_ID = '493639014923-7gqsn4g853icgtctj6hhugkcqhm6178e.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAtjXuMkQe9UZzWb-cNsztYy0II9StI08U';
    
    let tokenClient;
    let accessToken = localStorage.getItem('gdrive_token');
    let cloudPlaylist = JSON.parse(localStorage.getItem('my_cloud_songs') || '[]');

    function gapiLoaded() {
        gapi.load('client:picker', () => {
            gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.readonly',
            ux_mode: 'popup',
            callback: (resp) => {
                if (resp.access_token) {
                    accessToken = resp.access_token;
                    localStorage.setItem('gdrive_token', accessToken);
                    openPicker();
                }
            },
        });
    }

    function handleAuthClick() {
        accessToken ? openPicker() : tokenClient.requestAccessToken({prompt: ''});
    }

    function openPicker() {
        const view = new google.picker.View(google.picker.ViewId.DOCS);
        view.setMimeTypes("audio/mpeg,audio/mp3,audio/wav,audio/x-m4a");
        const picker = new google.picker.PickerBuilder()
            .addView(view)
            .setOAuthToken(accessToken)
            .setDeveloperKey(API_KEY)
            .setCallback(pickerCallback)
            .build();
        picker.setVisible(true);
    }

    async function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
            const file = data.docs[0];
            let rawName = file.name.replace(/\.[^/.]+$/, ""); 

            // --- CLEANING LOGIC ---
            let cleanName = rawName
                .replace(/320|kbps|www|com|mr-jatt|mp3|download|official|video|audio/gi, "")
                .replace(/[_-]/g, " ")
                .trim();

            document.getElementById('status-msg').innerText = "Searching iTunes for: " + cleanName;

            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(cleanName)}&entity=song&limit=1`);
                const itunes = await res.json();

                let song = {
                    id: file.id,
                    title: cleanName,
                    artist: "Unknown Artist",
                    art: "https://is1-ssl.mzstatic.com/image/thumb/Music115/v4/08/11/d2/0811d273-9ed4-3394-0488-7334d1abcc7f/source/512x512bb.jpg"
                };

                if (itunes.results && itunes.results.length > 0) {
                    const m = itunes.results[0];
                    song.title = m.trackName;
                    song.artist = m.artistName;
                    song.art = m.artworkUrl100.replace('100x100bb.jpg', '600x600bb.jpg');
                }

                cloudPlaylist.push(song);
                localStorage.setItem('my_cloud_songs', JSON.stringify(cloudPlaylist));
                document.getElementById('status-msg').innerText = "Added: " + song.title;
                render();
            } catch (err) {
                console.error(err);
                render();
            }
        }
    }

    function render() {
        const container = document.getElementById('list-container');
        if (!container) return;
        container.innerHTML = cloudPlaylist.map((song, i) => `
            <div class="song-row" onclick="playCloudSong('${song.id}', '${song.title.replace(/'/g, "\\'")}', '${song.artist.replace(/'/g, "\\'")}', '${song.art}')">
                <img class="song-art" src="${song.art}">
                <div class="song-details">
                    <h4>${song.title}</h4>
                    <p>${song.artist}</p>
                </div>
            </div>
        `).join('');
    }

    async function playCloudSong(id, title, artist, art) {
        const audio = document.getElementById('audio-engine');
        const streamUrl = `https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`;
        
        document.getElementById('mini-player').style.display = 'block';
        document.getElementById('current-art').src = art;
        document.getElementById('now-playing-title').innerText = title;
        document.getElementById('now-playing-artist').innerText = artist;

        audio.src = streamUrl;
        audio.load();
        audio.play();

        // Background Caching
        const cache = await caches.open('apple-music-cache-v1');
        const match = await cache.match(streamUrl);
        if (!match) {
            fetch(streamUrl).then(r => { if(r.ok) cache.put(streamUrl, r); });
        }
    }
</script>

<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

</body>
</html>
